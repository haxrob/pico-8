pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
-- gameball
-- robert

function _init()
 padx=52
 pady=122
 padw=24
 padh=4
 ballx=64
 bally=64
 ballsz=4
 ballxdir=5
 ballydir=-3
 score=0
 lives=5
 gameover=false
 sparks = {}
 cols = {7,10,9}

 opp_pad = {
	 x=52,
	 y=15,
	 w=24,
	 h=4,
	 score=0
 }

 shake={
	 h=0,
	 v=0,
	 t=0,
 }
 
end

function s_make(x,y,dirx,diry)
	local s = {
		x=x,
		y=y,
		dx=3*cos(rnd(1)),
		dy=sin(rnd(1)),
		c=cols[1],
		t=0,
		ddx=0.1,
		ddy=0.1,
		max_t=1+rnd(1),
		dirx=dirx,
		diry=diry
	}
	add(sparks,s)
end

function make_sparks(x,y,dirx,diry)
	for i=1,40 do
		s_make(x,y,dirx,diry)
	end
end

function s_update(s)
	s.x+=s.dx
	s.y+=s.dy
	
	s.dx+=s.ddx*(s.dirx*8)
	s.dy+=s.ddy
	s.ddy+=0.03
	//s.ddx+=0.2
	
	s.t+=0.1
	if s.t > s.max_t/3 then
		s.c=cols[2]
	end
	if s.t > 2*(s.max_t/3) then
		s.c=cols[3]
	end
	if s.t > s.max_t then
		del(sparks,s)
	end
end

function movep()
	if btn(0) then
		if padx > 0 then
			padx-=5
		end
	elseif btn(1) then
		if padx <= 128-padw then
			padx+=5
		end
	end
end

function hit() 
	if ballx >=padx and
		ballx <= padx+padw and
		bally>pady-padh then
		sfx(0)
		shake.v=1
		shake.h=1
		make_sparks(ballx,bally,0,-1)
		ballydir=-ballydir
		score+=15
	end
end

function moveb()
	ballx+=ballxdir
	bally+=ballydir
end

function bounceb()
	-- hit left side
	if ballx < ballsz*2 then
		ballxdir=-ballxdir
		sfx(0)
		//shake.h=1
		//make_sparks(ballx,bally,1,0)
	end
	
	-- hit right
	if ballx > 128-(ballsz*2) then
		ballxdir=-ballxdir
		sfx(0)
		//shake.h=1
		//make_sparks(ballx,bally,-1,0)
 end
	
	-- hit top
	if bally <= opp_pad.y+opp_pad.h+ballsz+2 then
		ballydir=-ballydir
		sfx(0)
		shake.v=1
		shake.h=1
		opp_pad.score+=15
		make_sparks(ballx,bally,0,1)
	end
end

function looseb()
	if bally > 127 then
			sfx(3)
			bally=opp_pad.y+20
			opp_pad.score+=100
			lives-=1
	end
	if lives <= 0 then
	sfx(002)
		_init()
	end
end

function do_shake()
	if shake.h==1 or shake.v==1 then
		camera(shake.h*cos(shake.t/2),shake.v*cos(shake.t/2))
		shake.t = shake.t+1
		if shake.t>5 then
			shake.t=0
			shake.v=0
			shake.h=0
			camera(0,0)
		end
	end
end


function _update()
 movep()
	bounceb()
	hit()
	moveb()
	looseb()	
	foreach(sparks,s_update)
	
	do_shake()
	//padx=ballx
end

function _draw()
	rectfill(0,0,128,128,0)
	//cls()
	//rectfill(padx, pady, padx+padw,pady+padh,15)
 spr(003,padx,pady,3,1)
 spr(003,ballx-(padw/2),opp_pad.y,3,1,false,true)
 //circfill(ballx,bally,ballsz,15)
	spr(001,ballx-ballsz,bally-ballsz)
	print(score,6,6,7)
	print(opp_pad.score,110,6,7)
	
	for i=1,lives do
		spr(002,36+i*8,4)
	end
	for s in all(sparks) do
		pset(s.x,s.y,s.c)
	end
	
	rect(0,0,127,127,1)
	
end
	
__gfx__
00000000005555000000000000677777777777777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000056666500880880056777777777777777777776500000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700566677658888978066666666666666666666666600000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000566677658888898055656565656565656565656500000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000566666650888880055555555555555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700566666650088800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000056666500008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100003e0503a050060500505007050050500405007050020500105001050010500105002050010500000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0004000024350233502335023350233502335022350223502235022350223502135021350213501c0502135021350213502135021350213502135021350213502135021350213502135021350213502135021350
0005000038050320502d0501e05019050130500e0500a050060500305000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000400003c05038050330503a25039250342502f2502c25026250232501d2501b25017250102500e2500b2500a250082500425003250120502a65025650236501d650206501e6501c65019650166501365010650
